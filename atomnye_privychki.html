<!DOCTYPE html>
<html lang="ru">

<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>Цифровая Библиотека</title>
   <meta name="description"
      content="Читайте книгу {book-title} от {book-author} онлайн с настройкой цветов и темы для комфортного чтения." />
   <link rel="stylesheet" href="styles/main.css" />
   <link rel="stylesheet" href="styles/reader.css" />
   <link rel="stylesheet" href="styles/reading-settings.css">
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

   <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
   <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
   <link rel="shortcut icon" href="/favicon/favicon.ico" />
   <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
</head>

<body>
   <div class="theme-toggle-container">
      <button id="theme-toggle" class="theme-toggle" aria-label="Переключить тему">
         <i class="fas fa-sun sun-icon"></i>
         <i class="fas fa-moon moon-icon"></i>
      </button>
   </div>
   <!-- Navigation -->
   <nav class="book-nav">
      <div class="nav-content">
         <a href="index.html" class="back-btn" data-testid="button-back-home">
            <i class="fas fa-chevron-left"></i>
            Назад к библиотеке
         </a>
      </div>
   </nav>
   <!-- Book Header -->
   <header class="book-header">
      <div class="container">
         <div class="book-header-content">
            <div class="book-cover-large">
               <img id="book-poster" src="/img/poster.jpg" alt="Обложка книги" />
            </div>
            <div class="book-details">
               <h1 class="book-title-large" id="book-title">Название книги</h1>
               <p class="book-author-large" id="book-author">Автор неизвестен</p>
               <p class="book-description-large" id="book-description">
                  Описание отсутствует
               </p>
               <div class="book-actions">
                  <button id="start-reading" class="btn-primary btn-large" data-testid="button-start-reading">
                     <i class="fas fa-book-open"></i>
                     Начать чтение
                  </button>
                  <button id="continue-reading" class="btn-secondary" style="display: none"
                     data-testid="button-continue-reading">
                     <i class="fas fa-arrow-right"></i>
                     Продолжить чтение
                  </button>

                  <!-- КНОПКА СКАЧИВАНИЯ КНИГИ -->
                  <a href="#" id="download-book" class="btn-secondary" data-testid="button-download-book">
                     <i class="fas fa-download"></i>
                     Скачать книгу
                  </a>


               </div>
               <div class="reading-progress">
                  <div class="progress-bar">
                     <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                  </div>
                  <span class="progress-text" id="progress-text">Прогресс: 0%</span>
               </div>
            </div>
         </div>
      </div>
   </header>
   <!-- Audio Section (will be hidden if no audio) -->
   <section class="audio-section" id="audio-section" style="display: none">
      <div class="container">
         <div class="audio-player" id="audio-player">
            <div class="audio-info">
               <h3 id="audio-title">Аудиокнига</h3>
               <p id="current-chapter-info">Выберите главу для прослушивания</p>
            </div>
            <div class="audio-controls">
               <div class="audio-controls-main">
                  <button id="prev-chapter" class="audio-btn" title="Предыдущая глава">
                     <i class="fas fa-step-backward"></i>
                  </button>

                  <button id="play-pause-btn" class="audio-btn" data-testid="button-audio-play">
                     <i class="fas fa-play play-icon"></i>
                     <i class="fas fa-pause pause-icon" style="display: none"></i>
                  </button>

                  <button id="next-chapter" class="audio-btn" title="Следующая глава">
                     <i class="fas fa-step-forward"></i>
                  </button>

                  <div class="audio-progress">
                     <span id="current-time">0:00</span>
                     <input type="range" id="audio-progress-bar" min="0" max="100" value="0" class="progress-slider" />
                     <span id="total-time">0:00</span>
                  </div>
               </div>

               <div class="volume-controls">
                  <button id="mute-btn" class="audio-btn">
                     <i class="fas fa-volume-up volume-icon"></i>
                     <i class="fas fa-volume-mute mute-icon" style="display: none"></i>
                  </button>
                  <input type="range" id="volume-control" min="0" max="100" value="100" class="volume-slider" />
               </div>
            </div>


         </div>
         <!-- Список глав аудиокниги -->
         <div class="chapters-list" id="chapters-list">
            <h4>Главы аудиокниги</h4>
            <div class="chapters-grid" id="chapters-grid">
               <!-- Главы будут добавлены автоматически через JavaScript -->
            </div>
         </div>
      </div>
   </section>
   <!-- Text Version Section (shown when no audio) -->
   <section class="text-version-section" id="text-version-section" style="display: none">
      <div class="container">
         <div class="text-version-content">
            <div class="text-version-icon">
               <i class="fas fa-book-reader"></i>
            </div>
            <div class="text-version-info">
               <h3>Только текстовая версия</h3>
               <p>
                  Для этой книги доступна только текстовая версия. Аудиозаписи
                  отсутствуют.
               </p>
               <p>
                  Вы можете насладиться чтением книги в удобном формате с настройкой
                  цветов и шрифтов.
               </p>
            </div>
            <div class="text-version-actions">
               <button id="start-text-reading" class="btn-primary">
                  <i class="fas fa-book-open"></i>
                  Начать чтение
               </button>
            </div>
         </div>
      </div>
   </section>
   <!-- Reading Mode Controls -->
   <div class="reading-mode-controls" id="reading-mode-controls" style="display: none">
      <div class="container">
         <div class="mode-selector">
            <h4>Режим чтения</h4>
            <div class="mode-buttons">
               <button id="page-mode" class="mode-btn active">
                  <i class="fas fa-file-alt"></i>
                  Страницы
               </button>
               <button id="scroll-mode" class="mode-btn">
                  <i class="fas fa-scroll"></i>
                  Прокрутка
               </button>
            </div>
         </div>
      </div>
   </div>










   <!-- Full Screen Reading Modal -->
   <div class="reading-modal" id="reading-modal" style="display: none">



<!-- Стрелки навигации -->
  <div class="nav-arrows">
    <div class="nav-arrow nav-arrow-prev" onclick="window.readingSettings.prevPage()">
      <i class="fas fa-chevron-left"></i>
    </div>
    <div class="nav-arrow nav-arrow-next" onclick="window.readingSettings.nextPage()">
      <i class="fas fa-chevron-right"></i>
    </div>
  </div>
  
  <!-- Индикатор страниц -->
  <div class="page-info">
    <span id="current-page">1</span> / <span id="total-pages">1</span>
  </div>
</div>


      <!-- Fixed Top Menu -->
      <div class="reading-menu">
         <div class="container-menu">
            <div class="reading-menu-left">
               <button id="exit-reading" class="exit-btn back-btn" data-testid="button-exit-reading">
                  <i class="fas fa-chevron-left"></i>
                  Выйти из режима чтения
               </button>
            </div>
            <div class="reading-menu-center">
               <span style="color: #fff" class="progress-text" id="progress-text">Прогресс: 0%</span>
            </div>
            <div class="reading-menu-right">

               <!-- В reading-menu-right -->
               <button id="reading-color-settings" class="menu-btn settings-btn">
                  <i class="fas fa-cog"></i>
                  Настроить
               </button>
            </div>
         </div>
      </div>
      <!-- Reading Content -->
      <div class="reading-content">
         <article class="book-content" id="book-content" style="
            background: var(--reader-page, var(--background-primary));
            color: var(--reader-text, var(--text-primary));
          ">
            <!-- Содержимое книги будет загружено здесь -->
         </article>
      </div>
   </div>
   <!-- Reading Controls -->
   <div class="reading-controls" id="reading-controls" style="display: none">
      <div class="control-buttons">
         <button id="prev-page" class="control-btn" title="Предыдущая страница">
            <i class="fas fa-chevron-left"></i>
         </button>
         <button id="next-page" class="control-btn" title="Следующая страница">
            <i class="fas fa-chevron-right"></i>
         </button>
         <div class="page-info">
            <span id="current-page">1</span> / <span id="total-pages">1</span>
         </div>
      </div>
   </div>









   <!-- Боковая панель настроек -->
   <div class="settings-sidebar" id="settings-sidebar">
      <div class="settings-header">
         <h3>Настройки чтения</h3>
         <button class="settings-close" id="settings-close">
            <i class="fas fa-times"></i>
         </button>
      </div>

      <div class="settings-content">

         <!-- Размер шрифта -->
         <div class="settings-group">
            <label>Размер текста</label>
            <div class="font-controls">
               <button id="font-size-decrease" class="btn-icon small">
                  <i class="fas fa-minus"></i>
               </button>
               <span id="font-size-display">18px</span>
               <button id="font-size-increase" class="btn-icon small">
                  <i class="fas fa-plus"></i>
               </button>
            </div>
         </div>

         <!-- Шрифт -->
         <div class="settings-group">
            <label>Шрифт</label>
            <select id="font-family-select" class="settings-select">
               <option value="Inter">Inter</option>
               <option value="Arial">Arial</option>
               <option value="Times New Roman">Times New Roman</option>
               <option value="Georgia">Georgia</option>
               <option value="Verdana">Verdana</option>
               <option value="Kazimir">Kazimir</option>
            </select>
         </div>

         <!-- Выравнивание -->
         <div class="settings-group">
            <label>Выравнивание</label>
            <div class="button-group">
               <button id="text-align-left" class="btn-icon" title="По левому краю">
                  <i class="fas fa-align-left"></i>
               </button>
               <button id="text-align-justify" class="btn-icon active" title="По ширине">
                  <i class="fas fa-align-justify"></i>
               </button>
            </div>
         </div>

         <!-- Режим чтения -->
         <div class="settings-group">
            <label>Режим</label>
            <div class="button-group">
               <button id="reading-mode-page" class="btn-icon active" title="Постранично">
                  <i class="fas fa-file-alt"></i>
               </button>
               <button id="reading-mode-scroll" class="btn-icon" title="Прокрутка">
                  <i class="fas fa-scroll"></i>
               </button>
            </div>
         </div>

         <!-- Темы -->
         <div class="settings-group">
            <label>Тема</label>
            <div class="themes-grid">
               <div class="theme-preset active" data-theme="dark" title="Тёмная">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #111827, #1f2937)"></div>
               </div>
               <div class="theme-preset" data-theme="dark-blue" title="Тёмно-синяя">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #0f172a, #1e293b)"></div>
               </div>
               <div class="theme-preset" data-theme="dark-warm" title="Тёмная тёплая">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #1c1917, #292524)"></div>
               </div>
               <div class="theme-preset" data-theme="light" title="Светлая">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #f8fafc, #ffffff)"></div>
               </div>
               <div class="theme-preset" data-theme="light-warm" title="Светлая тёплая">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #fdf2f8, #fefce8)"></div>
               </div>
               <div class="theme-preset" data-theme="sepia" title="Сепия">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #f5e6d3, #fdf6e3)"></div>
               </div>
               <div class="theme-preset" data-theme="blue" title="Голубая">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #e0f2fe, #f0f9ff)"></div>
               </div>
               <div class="theme-preset" data-theme="green" title="Зелёная">
                  <div class="theme-dot" style="background: linear-gradient(135deg, #f0fdf4, #ecfdf5)"></div>
               </div>
            </div>
         </div>
      </div>
   </div>

















   <script src="js/book-config.js"></script>
   <script src="js/theme.js"></script>
   <script src="js/audio-player.js"></script>
   <script src="js/book-loader.js"></script>
   <script src="js/reader.js"></script>
   <script src="js/color-customizer.js"></script>
   <script src="js/reading-settings.js"></script>
   <script>



      // Инициализация после загрузки DOM
      document.addEventListener("DOMContentLoaded", function () {
         // Инициализация настроек чтения
         window.readingSettings = new ReadingSettings();

         // Дополнительная проверка
         setTimeout(() => {
            if (window.readingSettings) {
               console.log("ReadingSettings initialized:",
                  window.readingSettings.currentSettings.readingMode);
            }
         }, 1000);
      });

      function initializeReadingPage() {
         console.log("Initializing reading page...");

         // Инициализация настроек чтения
         window.readingSettings = new ReadingSettings();

         // Дополнительная инициализация
         setTimeout(() => {
            window.readingSettings.calculatePages();
         }, 1000);

         // Обработчик изменения размера окна
         window.addEventListener("resize", () => {
            if (
               window.readingSettings &&
               window.readingSettings.currentSettings.readingMode === "page"
            ) {
               window.readingSettings.calculatePages();
               window.readingSettings.showCurrentPage();
            }
         });
      }






      // Book Page Initialization
      document.addEventListener("DOMContentLoaded", function () {
         const bookConfig = window.bookConfig
            ? window.bookConfig.getCurrentBook()
            : null;
         if (bookConfig) {
            // Update page metadata
            document.title = `${bookConfig.title || "Название книги"
               } - Цифровая Библиотека`;
            // Update book info
            document.getElementById("book-title").textContent =
               bookConfig.title || "Название книги";
            document.getElementById("book-author").textContent =
               bookConfig.author || "Автор неизвестен";
            document.getElementById("book-description").textContent =
               bookConfig.description || "Описание отсутствует";
            // Update poster
            const posterImg = document.getElementById("book-poster");
            posterImg.src =
               bookConfig.poster || "/img/poster.jpg";
            posterImg.alt = `${bookConfig.title || "Название книги"
               } - обложка книги`;
            // Set body data attributes
            document.body.setAttribute(
               "data-audio-folder",
               bookConfig.audioFolder || ""
            );
            document.body.setAttribute(
               "data-audio-count",
               bookConfig.audioCount || 0
            );
            document.body.setAttribute(
               "data-book-file",
               bookConfig.bookFile || ""
            );
            document.body.setAttribute(
               "data-book-type",
               bookConfig.bookFormat || ""
            );
            document.body.setAttribute(
               "data-poster-image",
               bookConfig.poster || "/img/poster.jpg"
            );
            // Show/hide audio section based on audio availability
            const audioSection = document.getElementById("audio-section");
            const textVersionSection = document.getElementById(
               "text-version-section"
            );
            if (bookConfig.audioCount && bookConfig.audioCount > 0) {
               audioSection.style.display = "block";
               document.getElementById("audio-title").textContent = `Аудиокнига: ${bookConfig.title || "Название книги"
                  }`;
            } else {
               textVersionSection.style.display = "block";
               // Connect text version button to reading functionality
               document
                  .getElementById("start-text-reading")
                  .addEventListener("click", function () {
                     document.getElementById("start-reading").click();
                  });
            }
            // Update continue button based on progress
            const progress = window.bookReader
               ? window.bookReader.loadReadingProgress()
               : { progress: 0 };
            const continueBtn = document.getElementById("continue-reading");
            if (progress.progress > 5) {
               continueBtn.style.display = "inline-flex";
               continueBtn.textContent = `Продолжить с ${Math.round(
                  progress.progress
               )}%`;
            }
         } else {
            // Fallback if book config not found
            console.error("Book configuration not found");
         }
      });


      // Добавим эту функцию в book-initializer.js
      function initializeDownloadMenu(bookConfig) {
         const downloadItems = document.getElementById('download-items');
         const downloadBtn = document.getElementById('download-btn');

         if (!downloadItems || !downloadBtn || !bookConfig) return;

         // Базовый путь к папке с книгой
         const bookBasePath = bookConfig.folder + 'book/';
         const bookName = bookConfig.id;

         // Возможные форматы файлов
         const possibleFormats = [
            { ext: 'fb2', icon: 'file-alt', name: 'FB2', type: 'FictionBook' },
            { ext: 'pdf', icon: 'file-pdf', name: 'PDF', type: 'PDF' },
            { ext: 'epub', icon: 'file-epub', name: 'EPUB', type: 'ePub' },
            { ext: 'txt', icon: 'file-text', name: 'TXT', type: 'Text' },
            { ext: 'doc', icon: 'file-word', name: 'DOC', type: 'Word' },
            { ext: 'docx', icon: 'file-word', name: 'DOCX', type: 'Word' }
         ];

         // Очищаем предыдущие элементы
         downloadItems.innerHTML = '';

         // Счетчик доступных форматов
         let availableFormats = 0;

         // Проверяем каждый формат
         possibleFormats.forEach(format => {
            const filePath = `${bookBasePath}${bookName}.${format.ext}`;

            // Создаем элемент меню (изначально скрытый)
            const item = document.createElement('a');
            item.className = 'download-item';
            item.href = filePath;
            item.download = `${bookName}.${format.ext}`;
            item.innerHTML = `
            <i class="fas fa-${format.icon}"></i>
            ${format.name}
            <span class="file-size">~2-5 МБ</span>
        `;

            // Проверяем существование файла
            checkFileExists(filePath).then(exists => {
               if (exists) {
                  downloadItems.appendChild(item);
                  availableFormats++;

                  // Показываем/скрываем основную кнопку в зависимости от наличия форматов
                  if (availableFormats === 0) {
                     downloadBtn.style.display = 'none';
                  }
               }
            }).catch(error => {
               console.error(`Error checking file ${filePath}:`, error);
            });
         });

         // Если после проверки нет доступных форматов, скрываем кнопку
         setTimeout(() => {
            if (availableFormats === 0) {
               downloadBtn.style.display = 'none';
            } else if (availableFormats === 1) {
               // Если только один формат, превращаем в прямую ссылку
               const singleItem = downloadItems.querySelector('.download-item');
               if (singleItem) {
                  downloadBtn.innerHTML = '<i class="fas fa-download"></i> Скачать ' +
                     singleItem.querySelector('i').className.match(/fa-file-(\w+)/)[1].toUpperCase();
                  downloadBtn.onclick = (e) => {
                     e.preventDefault();
                     window.location.href = singleItem.href;
                  };
                  downloadBtn.style.cursor = 'pointer';
                  document.querySelector('.download-menu').style.display = 'none';
               }
            }
         }, 1000);
      }

      // Функция проверки существования файла
      async function checkFileExists(url) {
         try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
         } catch (error) {
            return false;
         }
      }





      function initializeDownloadButton(bookConfig) {
         const downloadBtn = document.getElementById('download-book');

         if (!downloadBtn || !bookConfig || !bookConfig.id) {
            if (downloadBtn) {
               downloadBtn.style.display = 'none';
            }
            return;
         }

         const bookId = bookConfig.id;
         const format = bookConfig.bookFormat || 'fb2'; // Используем формат из конфига или fb2 по умолчанию

         // Формируем путь к файлу
         const bookFilePath = `books-pack/${bookId}/book/${bookId}.${format}`;

         // Устанавливаем атрибуты
         downloadBtn.href = bookFilePath;
         downloadBtn.setAttribute('download', `${bookId}.${format}`);

         console.log('Download configured:', bookFilePath);
      }





   </script>
   <style>
      /* Text Version Section Styles */
      .text-version-section {
         background: linear-gradient(135deg,
               var(--background-secondary) 0%,
               var(--background-primary) 100%);
         padding: 3rem 0;
         border-bottom: 1px solid var(--border-color);
      }

      .text-version-content {
         display: flex;
         align-items: center;
         gap: 2rem;
         max-width: 800px;
         margin: 0 auto;
         padding: 2rem;
         background: var(--background-primary);
         border-radius: var(--radius-xl);
         box-shadow: var(--shadow-lg);
         border: 1px solid var(--border-color);
      }

      .text-version-icon {
         font-size: 3rem;
         color: var(--primary-color);
         flex-shrink: 0;
      }

      .text-version-info {
         flex: 1;
      }

      .text-version-info h3 {
         color: var(--text-primary);
         margin-bottom: 1rem;
         font-size: 1.5rem;
      }

      .text-version-info p {
         color: var(--text-secondary);
         margin-bottom: 0.5rem;
         line-height: 1.6;
      }

      .text-version-actions {
         flex-shrink: 0;
      }

      @media (max-width: 768px) {
         .text-version-content {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
         }

         .text-version-icon {
            font-size: 2.5rem;
         }
      }

      @media (max-width: 480px) {
         .text-version-section {
            padding: 2rem 0;
         }

         .text-version-content {
            padding: 1rem;
         }

         .text-version-icon {
            font-size: 2rem;
         }
      }
   </style>
</body>

</html>